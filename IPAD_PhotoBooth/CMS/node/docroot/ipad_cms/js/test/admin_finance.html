
<script src="../yui/3.10.1/build/yui/yui-min.js"></script>

<!--LOCAL YUI GALLERY LOAD-->
<script src="../yui/gallery-base64.js" ></script>

<link rel="stylesheet" href="../yui/pure/0.1.0/pure-min.css">

<link rel="stylesheet" href="../css/purecss.io/combo/main.css">
<link rel="stylesheet" href="../css/purecss.io/combo/baby-blue.css">

<!-- css with a parent of yui3-skin-mine -->
<link rel="stylesheet" href="../css/my3.css">

<!-- css with a parent of pure-skin-mine4 -->
<link rel="stylesheet" href="../css/my4.css">

<!-- LIBS-->
<script src="../common/nyuams_common.js"></script>
 
        <!--MENU BAR-->
        <script src="../common/menu_bar.js"></script>

</head>


<script type="text/javascript">

var adf_current_selectionid = null;
var adf_current_selection_tr = null;
var adf_current_selection_model = null;
var adf_manual_selection_tr = null;
var adf_datatable = null;
var adf_event_id = null;
var adf_Y;
var data;

function make_table(Y)
{
	if (adf_datatable) adf_datatable.destroy();

	//  HERE'S WHERE WE GET THE SELECTION MODEL, IF WE NEED TO RETAIN SELECTION ACROSS TABLE REFRESH
	var selectionFormatter = function(o) {
		if ( adf_current_selectionid )
		{
console.log("SELECTION FORMATTER!");
			if ( o.data['accountid'] == adf_current_selectionid )
			{
				adf_current_selection_model = o.record;
			}
		}
		return o.data['code'];
	};

	var cols = [ {'key':'a', 'label':'A', formatter: selectionFormatter },
			{'key':'b', 'label':'B'} ];

	data = [ { 'accountid':1,'b':'bbbbb0'},
			{ 'accountid':2,'b':'bbbbb1'},
			{ 'accountid':3,'b':'bbbbb2'},
	];
	
        adf_datatable = new Y.DataTable({
                columns:cols,
                data:data,
                summary:"Parts",
                width:"100%",
		sortable:true,

                // "selection" config stuff begins here ...
                //highlightMode: 'row',
                //selectionMode: 'row',
                //selectionMulti: false

                }).render("#adf_datatable");

	adf_datatable.addAttr("selectedRow", { value: null });

    	adf_datatable.delegate('click', function (e) {
        	this.set('selectedRow', e.currentTarget);
     	}, '.yui3-datatable-data tr', adf_datatable);

	adf_datatable.after('selectedRowChange', 
		function (e)
		{
console.log("selectedrow");
			var tr = e.newVal,              // the Node for the TR clicked ...
        		last_tr = e.prevVal,        //  "   "   "   the last TR clicked ...
        		rec = adf_datatable.getRecord(tr);   // the current Record for the clicked TR

			//	remember new selection tr...
			adf_current_selection_tr = tr;

			//      if there is a manual selection in effect...
                        if ( adf_manual_selection_tr )
                        {
                                // get newly selected data id...
                                var selid = rec.get("accountid");

                                // remove selection classes if new selection != last one...
                                if (selid != adf_current_selectionid )
                                {
console.log("UNSETTING MANUAL SELECTION TR",adf_manual_selection_tr);
                                        adf_manual_selection_tr.removeClass("yui3-datatable-sel-selected");
                                        adf_manual_selection_tr.removeClass("yui3-datatable-sel-highlighted");
                                }

                                adf_manual_selection_tr = null;
                        }


			if ( !last_tr ) 
			{
    			} 
			else 
			{
        			last_tr.removeClass("yui3-datatable-sel-selected");
        			last_tr.removeClass("yui3-datatable-sel-highlighted");
			}

        		tr.addClass("yui3-datatable-sel-selected");
        		tr.addClass("yui3-datatable-sel-highlighted");

		        var accountid = rec.get('accountid');

                        // track selection across refreshes...
                        adf_current_selectionid = accountid;
			adf_current_selection_model = rec;

                        //      notify globally current accountid...
                        common_notify_selected_accountid( adf_event_id, accountid );	

		});

	adf_datatable.after("sort",
		function(obj)
		{
			Y.later(1000, adf_datatable, 
				function() 
				{ 
					if ( adf_current_selection_tr )
					{
						recalcit();
console.log("PORT SORT SELECTION", adf_current_selection_tr );
					}
				});
			return true;
		});

	recalcit();
}

function recalcit()
{
	// perform manual selection if needed...
	if (adf_current_selectionid && adf_current_selection_model )
	{

		var tr = adf_datatable.getRow(adf_current_selection_model);
				tr.addClass("yui3-datatable-sel-selected");
                		tr.addClass("yui3-datatable-sel-highlighted");
				adf_manual_selection_tr = tr;
console.log("recalc tr", tr);
/*
		//	find if row exists in current table...
		for ( var d=0; d< data.length; d++ )
		{
			if ( data[d]['accountid'] == adf_current_selectionid )
			{
				var tr = adf_datatable.getRow(d);
				tr.addClass("yui3-datatable-sel-selected");
                		tr.addClass("yui3-datatable-sel-highlighted");
				adf_manual_selection_tr = tr;
console.log("MANUAL SELECTION MODEL", tr, tr.id);
				break;
			}
		}
*/
	}
}

function addit()
{
	if ( adf_current_selection_tr)
	{
console.log("ADD TR", adf_current_selection_tr);
		adf_current_selection_tr.addClass("yui3-datatable-sel-selected");
                adf_current_selection_tr.addClass("yui3-datatable-sel-highlighted");
	}
}

function removeit()
{
	if ( adf_current_selection_tr)
	{
console.log("REMOVING TR", adf_current_selection_tr);
		adf_current_selection_tr.removeClass("yui3-datatable-sel-selected");
                adf_current_selection_tr.removeClass("yui3-datatable-sel-highlighted");
	}
}

function prev()
{
	console.log("prev!");
	if ( adf_current_selection_tr )
	{
		var dom = adf_current_selection_tr.getDOMNode();
		var sibling = dom.previousSibling;
		console.log(sibling);
		if (sibling)
		{
			var tr = adf_Y.Node(sibling);
                        var rec = adf_datatable.getRecord(tr);
                        console.log("PREV!!!", tr, rec );

                        if (adf_current_selection_tr)   
                        {
                                adf_current_selection_tr.removeClass("yui3-datatable-sel-selected");
                                adf_current_selection_tr.removeClass("yui3-datatable-sel-highlighted");
                        }

                        tr.addClass("yui3-datatable-sel-selected");
                        tr.addClass("yui3-datatable-sel-highlighted");

                        adf_current_selection_tr = tr;
                        adf_current_selectionid = rec.get("accountid");
                        adf_current_selection_model = rec;
		}
	}
}

function next()
{
	console.log("next!");
	if ( adf_current_selection_tr )
	{
		var dom = adf_current_selection_tr.getDOMNode();
		var sibling = dom.nextSibling;
		console.log(sibling);
		if (sibling) 
		{
                        var tr = adf_Y.Node(sibling);
                        var rec = adf_datatable.getRecord(tr);
                        console.log("NEXT!!!", tr, rec );
			
			if (adf_current_selection_tr)	
			{
		                adf_current_selection_tr.removeClass("yui3-datatable-sel-selected");
                		adf_current_selection_tr.removeClass("yui3-datatable-sel-highlighted");
			}
			
			tr.addClass("yui3-datatable-sel-selected");
			tr.addClass("yui3-datatable-sel-highlighted");

			adf_current_selection_tr = tr;
			adf_current_selectionid = rec.get("accountid");
			adf_current_selection_model = rec;	
                }
	}
}

function init()
{
       yui_initialize( function(Y)
	         	{
				adf_event_id = Y.guid();
				adf_Y = Y;

				make_table(Y);	

				var body = Y.Node(document.body);
				var html = '<button onclick="make_table(adf_Y);">make</button>';
				html += '<button onclick="addit();">add</button>';
				html += '<button onclick="removeit();">remove</button>';
				html += '<button onclick="recalcit();">recalc</button>';
				var el = Y.Node.create(html);
				body.append( el );

				body.on('keyup', function (e) {
					console.log(e.keyCode);
					if ( e.keyCode == 38 ) prev();	
					else if ( e.keyCode == 40 ) next();	
					return true;
				});
                        });
}

</script>

<body class="yui3-skin-mine" onload="init();">

<div id="adf_datatable"></div>

</body>
